SET SERVEROUTPUT ON
CREATE OR REPLACE FUNCTION FN_VALIDA_CNPJ (V_DO_CNPJ VARCHAR2)
RETURN VARCHAR2 IS
 
V_CNJP VARCHAR2 (15):= V_DO_CNPJ;
V_CNPJ_VALIDO VARCHAR2(15);
V_POSICAO NUMBER :=6;
V_POSICAO2 NUMBER :=9;
V_POSICAO3 NUMBER :=7;
V_POSICAO4 NUMBER :=9;
V_CALCULO NUMBER :=0;
V_CALCULO2 NUMBER :=0;
V_CALCULO3 NUMBER :=0;
V_CALCULO4 NUMBER :=0;
V_CALCULO5 NUMBER :=0;
V_CALCULO6 NUMBER :=0;
V_CALCULO7 NUMBER :=0;
v_digito_total NUMBER :=0;
V_DIG1 VARCHAR2 (1);
V_DIG2 VARCHAR2 (10);
BEGIN
    IF V_CNJP =0 THEN
        RETURN('O número do CNPJ indicado é zero! Corrija e tente novamente! ');
        ELSE
        V_CNPJ_VALIDO := LPAD(V_CNJP,15,'0');
    
    FOR X IN 1..15
    LOOP
        IF UPPER(SUBSTR(V_CNPJ_VALIDO,X,1)) NOT IN ('0','1','2','3','4','5','6','7','8','9') THEN
         DBMS_OUTPUT.PUT_LINE('Digite apenas números ');
        END IF; 
    END LOOP;
    --CALCULO 1
    FOR Y IN 1..5
    LOOP
    V_CALCULO := V_CALCULO + (TO_NUMBER(SUBSTR(V_CNPJ_VALIDO,Y,1)) * V_POSICAO);
    V_POSICAO := V_POSICAO - 1;
    END LOOP;
 
    FOR Z IN 6..13
    LOOP
    V_CALCULO2 := V_CALCULO2 + (TO_NUMBER(SUBSTR(V_CNPJ_VALIDO,Z,1)) * V_POSICAO2);
    V_POSICAO2 := V_POSICAO2 - 1;
    V_CALCULO3 := V_CALCULO + V_CALCULO2;
    END LOOP;
    
    IF MOD(V_CALCULO3,11)<2 THEN
        V_DIG1 :=0;
    ELSE
        V_DIG1 := 11-MOD(V_CALCULO3,11);
    END IF;    
           
         --CALCULO 2
          FOR A IN 1..6
    LOOP
    V_CALCULO4 := V_CALCULO4 + (TO_NUMBER(SUBSTR(V_CNPJ_VALIDO,A,1)) * V_POSICAO3);
    V_POSICAO3 := V_POSICAO3 - 1;
    END LOOP;
    
              FOR B IN 7..13
    LOOP
    V_CALCULO5 := V_CALCULO5 + (TO_NUMBER(SUBSTR(V_CNPJ_VALIDO,B,1)) * V_POSICAO4);
    V_POSICAO4 := V_POSICAO4 - 1;
    V_CALCULO6 :=V_CALCULO4 + V_CALCULO5;
    V_CALCULO7:=V_CALCULO6+(V_DIG1*2);
    END LOOP;

    IF MOD(V_CALCULO7,11)<2 THEN
        V_DIG2 :=0;
		v_digito_total:=V_DIG1||V_DIG2;
    ELSE
        V_DIG2 := 11-MOD(V_CALCULO7,11);
        v_digito_total:=V_DIG1||V_DIG2;
    END IF;  
    
    IF TO_NUMBER(SUBSTR(V_CNPJ_VALIDO,14,2))=v_digito_total THEN
    RETURN('VALIDO');
    ELSE
    RETURN('INVALIDO');
    END IF;
END IF;
END FN_VALIDA_CNPJ;
/



-- USAR FUNCAO FN_VALIDA_CNPJ

SELECT FN_VALIDA_CNPJ(07773948000129)
FROM DUAL;

SELECT FN_VALIDA_CNPJ(N.NR_CNPJ)
FROM T_MC_CLI_JURIDICA N;


SET SERVEROUTPUT ON
BEGIN
            dbms_output.put_line(FN_VALIDA_CNPJ('0') );    
END;
/

SELECT * FROM T_MC_CLI_JURIDICA
